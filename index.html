<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://unpkg.com/simpleheat/simpleheat.js"></script>
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css" />

    <style>
      * {
        margin: 0;
        padding: 0;
      }
      .match-card {
        padding: 10px;
        cursor: pointer;
        display: flex;
        justify-content: space-around;
      }
      .selected {
        border-bottom: 1px solid black;
      }
    </style>
  </head>
  <body>
    <div
      style="
        width: 100%;
        height: 100px;
        background-color: rgb(163, 7, 7);
        display: flex;
        align-items: center;
        position: relative;
        padding: 10px;
        box-sizing: border-box;
      "
    >
      <img src="img/904/logo.png" height="100%" width="auto" alt="" />
      <h1
        style="
          color: white;
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          margin: 0;
          font-size: 2.5rem;
        "
      >
        Bayer Leverkusen Season 2023/2024
      </h1>
    </div>
    <div style="display: flex; width: 100%">
      <main style="width: 70%; padding: 30px">
        <div id="overall-season-statistics" style="width: 100%">
          <div id="top-goalscorers-wrapper" style="width: 100%">
            <h3>Top Goal Contributors</h3>
            <div id="top-goalscorers-barchart" style="width: 100%"></div>
          </div>
        </div>
        <div
          id="match-statistics"
          style="width: 100%; min-height: 500px; position: relative"
        >
          <p
            style="
              position: absolute;
              top: 35%;
              left: 50%;
              transform: translate(-50%, -50%);
              width: 100%;
              text-align: center;
            "
          >
            Select match to show statistics
          </p>
        </div>
      </main>
      <aside style="width: 30%; padding: 30px"></aside>
    </div>
    <script>
      const bayerId = 904;
      var lineups;
      var positions;
      var matchInfo;
      var events;
      var statistics;
      var matchId;
      var matches;

      var mainElement = document.querySelector("main");

      var width = mainElement.offsetWidth;
      var height = 0.55 * width;

      var offsetX = 50;
      var offsetY = 50;

      var scalePosX = d3.scale
        .linear()
        .domain([0, 120])
        .range([offsetX, width - offsetX]);
      var scalePosY = d3.scale
        .linear()
        .domain([0, 80])
        .range([offsetY, height - offsetY]);

      var scaleWidth = d3.scale
        .linear()
        .domain([0, 120])
        .range([0, width - offsetX * 2]);
      var scaleHeight = d3.scale
        .linear()
        .domain([0, 80])
        .range([0, height - offsetY * 2]);

      async function getTopGoalContributors() {
        const matchesResponse = await fetch("data/matches/9/281.json");
        matches = await matchesResponse.json(); // Parse the JSON

        var orderedMatches = matches.sort((a, b) => {
          return a.match_week - b.match_week;
        });

        var matchEventFiles = orderedMatches.map((match) => {
          return {
            file: `data/events/${match.match_id}.json`,
            match_id: match.match_id,
          };
        });

        var spiderWebData = [];

        let totalGoalsConceded = 0;
        let totalGoalsGiven = 0;
        let avgPossession = 0;
        let gamesCount = 0;
        let expectedGoalsxg = 0;

        let totalGoalScorrers = [];

        for (const matchEvent of matchEventFiles) {
          let goalsData = getGoalsData(matches, matchEvent.match_id);

          totalGoalsConceded += goalsData.goalsConceded;
          totalGoalsGiven += goalsData.goalsGiven;

          const matchEventsResponse = await fetch(matchEvent.file);
          const matchEvents = await matchEventsResponse.json();

          let possessionData = getAvgPossesion(matchEvents);
          let possession = possessionData.bayerPossessionPercentage;

          let expectedGoals = getExpectedGoals(matchEvents);

          let formation;
          let matchPos = matchEvents.find(
            (m) => m.type.id == 35 && m.team.id == 904
          );
          if (matchPos?.type?.id == 35) {
            formation = matchPos?.tactics?.formation;
          }

          // Check if this formation already exists in spiderWebData
          const existing = spiderWebData.find(
            (swd) => swd.formation == formation
          );
          if (existing) {
            existing.goalsGiven += goalsData.goalsGiven;
            existing.goalsConceded += goalsData.goalsConceded;
            existing.gamesCount += 1;
            existing.possession += possession;
            existing.expectedGoals += expectedGoals;
          } else {
            spiderWebData.push({
              formation: formation,
              goalsGiven: goalsData.goalsGiven,
              goalsConceded: goalsData.goalsConceded,
              gamesCount: 1,
              possession: possession,
              expectedGoals: expectedGoals,
            });
          }

          var goalScorers = getGoalScorers(matchEvents);
          goalScorers.forEach((scorer) => {
            let existingScorer = totalGoalScorrers.find(
              (s) => s.player_id == scorer.player_id
            );
            if (existingScorer) {
              existingScorer.goals += scorer.goals;
              existingScorer.assists += scorer.assists;
            } else {
              totalGoalScorrers.push(scorer);
            }
          });
        }

        var goalScorersSorted = totalGoalScorrers
          .slice()
          .sort((a, b) => b.goals + b.assists - (a.goals + a.assists))
          .slice(0, 5);

        console.log("Goal Scorers:", goalScorersSorted);
        return goalScorersSorted;
      }

      (async function drawTopGoalScorersBarChart() {
        var goalScorers = await getTopGoalContributors();
        var container = d3.select("[id=top-goalscorers-barchart]");
        var margin = { top: 40, right: 30, bottom: 40, left: 200 };
        var width = 600,
          height = 300;

        var svg = container
          .append("svg")
          .attr("id", "top-goalscorers-barchart-svg")
          .attr("width", width)
          .attr("height", height);

        // Prepare data for grouped bars
        var categories = ["Goals", "Assists", "Goal Contributions"];
        var data = goalScorers.map((d) => ({
          player_name: d.player_name,
          Goals: d.goals,
          Assists: d.assists,
          "Goal Contributions": d.goals + d.assists,
        }));

        var y = d3.scale
          .ordinal()
          .domain(data.map((d) => d.player_name))
          .rangeRoundBands([margin.top, height - margin.bottom], 0.2);

        var x = d3.scale
          .linear()
          .domain([
            0,
            d3.max(data, (d) =>
              Math.max(d.Goals, d.Assists, d["Goal Contributions"])
            ),
          ])
          .range([margin.left, width - margin.right]);

        var color = d3.scale
          .ordinal()
          .domain(categories)
          .range(["#1f77b4", "#ff7f0e", "#2ca02c"]);

        // Draw y axis (player names)
        svg
          .append("g")
          .attr("class", "y axis")
          .attr("transform", `translate(${margin.left - 10},0)`)
          .call(d3.svg.axis().scale(y).orient("left"));

        // Draw x axis
        svg
          .append("g")
          .attr("class", "x axis")
          .attr("transform", `translate(0,${height - margin.bottom})`)
          .call(d3.svg.axis().scale(x).orient("bottom").ticks(5));

        // Draw grouped bars
        var barGroup = svg
          .selectAll(".bar-group")
          .data(data)
          .enter()
          .append("g")
          .attr("class", "bar-group")
          .attr("transform", (d) => `translate(0,${y(d.player_name)})`);

        var barWidth = y.rangeBand() / 4;

        categories.forEach((cat, i) => {
          barGroup
            .append("rect")
            .attr("x", margin.left)
            .attr("y", i * barWidth)
            .attr("height", barWidth - 4)
            .attr("width", (d) => x(d[cat]) - margin.left)
            .attr("fill", color(cat));

          // Value label
          barGroup
            .append("text")
            .attr("x", (d) => x(d[cat]) + 5)
            .attr("y", i * barWidth + barWidth / 2 + 2)
            .attr("font-size", "12px")
            .attr("fill", "#222")
            .text((d) => d[cat]);
        });

        // Legend
        var legend = svg
          .selectAll(".legend")
          .data(categories)
          .enter()
          .append("g")
          .attr("class", "legend")
          .attr(
            "transform",
            (d, i) => `translate(${margin.left + i * 120},${margin.top - 30})`
          );

        legend
          .append("rect")
          .attr("width", 18)
          .attr("height", 18)
          .attr("fill", color);

        legend
          .append("text")
          .attr("x", 24)
          .attr("y", 13)
          .attr("font-size", "13px")
          .text((d) => d);

        // Title
        svg
          .append("text")
          .attr("x", margin.left)
          .attr("y", margin.top - 45)
          .attr("font-size", "18px")
          .attr("font-weight", "bold")
          .text("Top 5 Goal Scorers: Goals, Assists, Contributions");
      })();

      async function getPositionsWebData() {
        const matchesResponse = await fetch("data/matches/9/281.json");
        matches = await matchesResponse.json(); // Parse the JSON

        var orderedMatches = matches.sort((a, b) => {
          return a.match_week - b.match_week;
        });

        var matchEventFiles = orderedMatches.map((match) => {
          return {
            file: `data/events/${match.match_id}.json`,
            match_id: match.match_id,
          };
        });

        var spiderWebData = [];

        let totalGoalsConceded = 0;
        let totalGoalsGiven = 0;
        let avgPossession = 0;
        let gamesCount = 0;
        let expectedGoalsxg = 0;

        let totalGoalScorrers = [];

        for (const matchEvent of matchEventFiles) {
          let goalsData = getGoalsData(matches, matchEvent.match_id);

          totalGoalsConceded += goalsData.goalsConceded;
          totalGoalsGiven += goalsData.goalsGiven;

          const matchEventsResponse = await fetch(matchEvent.file);
          const matchEvents = await matchEventsResponse.json();

          let possessionData = getAvgPossesion(matchEvents);
          let possession = possessionData.bayerPossessionPercentage;

          let expectedGoals = getExpectedGoals(matchEvents);

          let formation;
          let matchPos = matchEvents.find(
            (m) => m.type.id == 35 && m.team.id == 904
          );
          if (matchPos?.type?.id == 35) {
            formation = matchPos?.tactics?.formation;
          }

          // Check if this formation already exists in spiderWebData
          const existing = spiderWebData.find(
            (swd) => swd.formation == formation
          );
          if (existing) {
            existing.goalsGiven += goalsData.goalsGiven;
            existing.goalsConceded += goalsData.goalsConceded;
            existing.gamesCount += 1;
            existing.possession += possession;
            existing.expectedGoals += expectedGoals;
          } else {
            spiderWebData.push({
              formation: formation,
              goalsGiven: goalsData.goalsGiven,
              goalsConceded: goalsData.goalsConceded,
              gamesCount: 1,
              possession: possession,
              expectedGoals: expectedGoals,
            });
          }

          var goalScorers = getGoalScorers(matchEvents);
          goalScorers.forEach((scorer) => {
            let existingScorer = totalGoalScorrers.find(
              (s) => s.player_id == scorer.player_id
            );
            if (existingScorer) {
              existingScorer.goals += scorer.goals;
              existingScorer.assists += scorer.assists;
            } else {
              totalGoalScorrers.push(scorer);
            }
          });
        }

        var goalScorersSorted = totalGoalScorrers
          .slice()
          .sort((a, b) => b.goals + b.assists - (a.goals + a.assists))
          .slice(0, 5);

        console.log("Goal Scorers:", goalScorersSorted);

        drawTopGoalScorersBarChart(goalScorersSorted);

        spiderWebData.forEach((data) => {
          data.possession = customRound(data.possession / data.gamesCount);
        });

        let totalxG = 0;
        spiderWebData.forEach((data) => {
          totalxG += data.expectedGoals;
        });

        return {
          spiderWebData,
          totalGoalsGiven,
          totalGoalsConceded,
          totalxG,
          totalGames: 34,
        };
      }

      function getExpectedGoals(events) {
        let expectedGoals = 0;
        events.forEach((event) => {
          if (event.type.id == 16 && event.team.id == bayerId) {
            expectedGoals += event.shot.statsbomb_xg;
          }
        });
        return expectedGoals;
      }

      function getAvgPossesion(events) {
        let bayerPossessions = 0;
        let awayTeamPossessions = 0;
        events.forEach((event) => {
          if (event.possession_team.id == bayerId) {
            bayerPossessions++;
          } else {
            awayTeamPossessions++;
          }
        });
        var bayerPossessionPercentage = customRound(
          (bayerPossessions / events.length) * 100
        );
        var awayTeamPossessionPercentage = customRound(
          (awayTeamPossessions / events.length) * 100
        );
        return {
          bayerPossessionPercentage: bayerPossessionPercentage,
          awayTeamPossessionPercentage: awayTeamPossessionPercentage,
        };
      }

      function getGoalScorers(events) {
        let goalScorers = [];
        events.forEach((event) => {
          if (
            event.type.id == 16 &&
            event.team.id == bayerId &&
            event.shot.outcome.id == 97
          ) {
            let player = event.player;
            let existingPlayer = goalScorers.find(
              (p) => p.player_id == player.id
            );
            if (existingPlayer) {
              existingPlayer.goals++;
            } else {
              goalScorers.push({
                player_id: player.id,
                player_name: player.name,
                goals: 1,
                assists: 0,
              });
            }
          } else if (
            event.type.id == 30 &&
            event.team.id == bayerId &&
            event.pass?.goal_assist == true
          ) {
            let player = event.player;
            let existingPlayer = goalScorers.find(
              (p) => p.player_id == player.id
            );
            if (existingPlayer) {
              existingPlayer.assists++;
            } else {
              goalScorers.push({
                player_id: player.id,
                player_name: player.name,
                goals: 0,
                assists: 1,
              });
            }
          }
        });
        return goalScorers.sort((a, b) => b.goals - a.goals);
      }

      function getGoalsData(matches, matchID) {
        var match = matches.find((m) => m.match_id == matchID);
        let goalsGiven = 0;
        let goalsConceded = 0;
        if (match.home_team.home_team_id == 904) {
          goalsGiven = match.home_score;
          goalsConceded = match.away_score;
        } else {
          goalsGiven = match.away_score;
          goalsConceded = match.home_score;
        }
        return {
          goalsGiven: goalsGiven,
          goalsConceded: goalsConceded,
          matchId: matchID,
        };
      }

      function clearPlayers() {
        d3.selectAll(".home-players").remove();
        d3.selectAll(".away-players").remove();
      }

      function positionPlayers() {
        var homePlayers = lineups[0]["lineup"].filter((player) => {
          return player["positions"]
            .map((pos) => pos["start_reason"])
            .includes("Starting XI");
        });
        var awayPlayers = lineups[1]["lineup"].filter((player) => {
          return player["positions"]
            .map((pos) => pos["start_reason"])
            .includes("Starting XI");
        });

        var homePlayersWithPositions = homePlayers.map((player) => {
          var playerPosition = positions[0].positions.find((pos) => {
            return pos["position_id"] == player["positions"][0]["position_id"];
          });
          return {
            player_id: player["player_id"],
            player_name: player["player_name"],
            player_number: player["jersey_number"],
            position: playerPosition["position_name"],
            x: playerPosition["location"][0],
            y: playerPosition["location"][1],
          };
        });

        console.log(homePlayersWithPositions);
        var awayPlayersWithPositions = awayPlayers.map((player) => {
          var playerPosition = positions[1].positions.find((pos) => {
            return pos["position_id"] == player["positions"][0]["position_id"];
          });
          return {
            player_id: player["player_id"],
            player_name: player["player_name"],
            player_number: player["jersey_number"],
            position: playerPosition["position_name"],
            x: playerPosition["location"][0],
            y: playerPosition["location"][1],
          };
        });
        console.log(awayPlayersWithPositions);

        // Draw home players
        var homeGroup = d3
          .select("[id=teren]")
          .append("g")
          .attr("class", "home-players");

        var homePlayers = homeGroup
          .selectAll("g.player")
          .data(homePlayersWithPositions)
          .enter()
          .append("g")
          .attr("class", "player")
          .attr("transform", function (d) {
            return "translate(" + scalePosX(d.x) + "," + scalePosY(d.y) + ")";
          });

        homePlayers
          .append("circle")
          .attr("r", 18)
          .attr("fill", "white")
          .attr("stroke", "blue")
          .attr("stroke-width", 3);

        homePlayers
          .append("text")
          .attr("text-anchor", "middle")
          .attr("dy", "0.35em")
          .attr("font-size", "16px")
          .attr("font-weight", "bold")
          .attr("fill", "blue")
          .text(function (d) {
            return d.player_number;
          });

        homePlayers
          .append("text")
          .attr("text-anchor", "middle")
          .attr("dy", "2.2em")
          .attr("font-size", "12px")
          .text(function (d) {
            return d.position;
          });

        // Draw away players
        var awayGroup = d3
          .select("[id=teren]")
          .append("g")
          .attr("class", "away-players");

        var awayPlayers = awayGroup
          .selectAll("g.player")
          .data(awayPlayersWithPositions)
          .enter()
          .append("g")
          .attr("class", "player")
          .attr("transform", function (d) {
            return "translate(" + scalePosX(d.x) + "," + scalePosY(d.y) + ")";
          });

        awayPlayers
          .append("circle")
          .attr("r", 18)
          .attr("fill", "white")
          .attr("stroke", "red")
          .attr("stroke-width", 3);

        awayPlayers
          .append("text")
          .attr("text-anchor", "middle")
          .attr("dy", "0.35em")
          .attr("font-size", "16px")
          .attr("font-weight", "bold")
          .attr("fill", "red")
          .text(function (d) {
            return d.player_number;
          });

        awayPlayers
          .append("text")
          .attr("text-anchor", "middle")
          .attr("dy", "2.2em")
          .attr("font-size", "12px")
          .text(function (d) {
            return d.position;
          });

        // Tooltip div
        var tooltip = d3
          .select("body")
          .append("div")
          .attr("class", "player-tooltip")
          .style("position", "absolute")
          .style("background", "rgba(255,255,255,0.95)")
          .style("border", "1px solid #333")
          .style("padding", "8px 12px")
          .style("border-radius", "6px")
          .style("pointer-events", "none")
          .style("font", "14px sans-serif")
          .style("display", "none")
          .style("z-index", 1000);

        function showTooltip(d) {
          tooltip
            .html(
              `<strong>${d.player_name}</strong><br>
          Number: ${d.player_number}<br>
          Position: ${d.position}`
            )
            .style("left", d3.event.pageX + 15 + "px")
            .style("top", d3.event.pageY - 28 + "px")
            .style("display", "block");
        }

        function hideTooltip() {
          tooltip.style("display", "none");
        }

        d3.selectAll("g.player")
          .on("mouseover", function (d) {
            d3.select(this).select("circle").attr("fill", "#f0f8ff");
            showTooltip(d);
          })
          .on("mousemove", function (d) {
            tooltip
              .style("left", d3.event.pageX + 15 + "px")
              .style("top", d3.event.pageY - 28 + "px");
          })
          .on("mouseout", function (d) {
            d3.select(this).select("circle").attr("fill", "white");
            hideTooltip();
          });
      }

      function drawTeren() {
        // Remove previous teren if exists
        d3.select("#teren").remove();

        var teren = d3
          .select("[id=match-statistics]")
          .append("svg")
          .attr("id", "teren")
          .attr("width", width)
          .attr("height", height)
          .style("background-color", "green")
          .append("g")
          .attr("class", "teren");

        var outerLine = d3
          .select(".teren")
          .append("rect")
          .attr("x", scalePosX(0))
          .attr("y", scalePosY(0))
          .attr("width", scaleWidth(120))
          .attr("height", scaleHeight(80))
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2);

        var centarLine = d3
          .select(".teren")
          .append("line")
          .attr("x1", scalePosX(60))
          .attr("y1", scalePosY(0))
          .attr("x2", scalePosX(60))
          .attr("y2", scalePosY(80))
          .attr("stroke", "white")
          .attr("stroke-width", 2);

        var centarCircle = d3
          .select(".teren")
          .append("circle")
          .attr("cx", scalePosX(60))
          .attr("cy", scalePosY(40))
          .attr("r", 70)
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2);

        var homeBox = d3
          .select(".teren")
          .append("rect")
          .attr("x", scalePosX(0))
          .attr("y", scalePosY(18))
          .attr("width", scaleWidth(18))
          .attr("height", scaleHeight(44))
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2);

        var homeMinBox = d3
          .select(".teren")
          .append("rect")
          .attr("x", scalePosX(0))
          .attr("y", scalePosY(30))
          .attr("width", scaleWidth(6))
          .attr("height", scaleHeight(20))
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2);

        var home11Spot = d3
          .select(".teren")
          .append("circle")
          .attr("cx", scalePosX(11))
          .attr("cy", scalePosY(40))
          .attr("r", 3)
          .attr("fill", "white");

        var homeHalfCircle = d3
          .select(".teren")
          .append("path")
          .attr(
            "d",
            `M ${scalePosX(15)} ${scalePosY(40)} A ${scalePosX(10)} ${scalePosY(
              19
            )} 0 0 0 ${scaleWidth(5)} ${scalePosY(40)}`
          )
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2)
          .attr(
            "transform",
            `rotate(90 ${scalePosX(18)} ${scalePosY(40)}) translate(${scalePosX(
              5.5
            )} 0)`
          );

        var awayHalfCircle = d3
          .select(".teren")
          .append("path")
          .attr(
            "d",
            `M ${scalePosX(90) + scalePosX(6)} ${scalePosY(40)} A ${scalePosX(
              9
            )} ${scalePosY(14)} 0 0 0 ${
              scalePosX(104.5) - scalePosX(13.5)
            } ${scalePosY(40)}`
          )
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2)
          .attr(
            "transform",
            `rotate(-90 ${scalePosX(102)} ${scalePosY(
              40
            )}) translate(${scalePosX(4.5)} 0)`
          );

        var awayBox = d3
          .select(".teren")
          .append("rect")
          .attr("x", scalePosX(102))
          .attr("y", scalePosY(18))
          .attr("width", scaleWidth(18))
          .attr("height", scaleHeight(44))
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2);

        var awayMinBox = d3
          .select(".teren")
          .append("rect")
          .attr("x", scalePosX(114))
          .attr("y", scalePosY(30))
          .attr("width", scaleWidth(6))
          .attr("height", scaleHeight(20))
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2);

        var away11Spot = d3
          .select(".teren")
          .append("circle")
          .attr("cx", scalePosX(109))
          .attr("cy", scalePosY(40))
          .attr("r", 3)
          .attr("fill", "white");

        var awayGoal = d3
          .select(".teren")
          .append("rect")
          .attr("x", scalePosX(120))
          .attr("y", scalePosY(36))
          .attr("width", scaleWidth(2))
          .attr("height", scaleHeight(8))
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2);

        var awayGoal = d3
          .select(".teren")
          .append("rect")
          .attr("x", scalePosX(0) - scaleWidth(2))
          .attr("y", scalePosY(36))
          .attr("width", scaleWidth(2))
          .attr("height", scaleHeight(8))
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2);

        return teren;
      }

      function drawPossessionStats(locations) {
        // Remove previous visualization if exists
        d3.select("#heatmap").remove();
        d3.select("#zone-stats").remove();

        // Define thirds (defence, midfield, attack)
        // Pitch is 120 units long: 0-40 (defence), 40-80 (midfield), 80-120 (attack)
        const thirds = [
          { name: "Defence", start: 0, end: 40 },
          { name: "Midfield", start: 40, end: 80 },
          { name: "Attack", start: 80, end: 120 },
        ];

        // Count events in each third
        const counts = [0, 0, 0];
        locations.forEach((loc) => {
          if (loc.x >= thirds[0].start && loc.x < thirds[0].end) counts[0]++;
          else if (loc.x >= thirds[1].start && loc.x < thirds[1].end)
            counts[1]++;
          else if (loc.x >= thirds[2].start && loc.x <= thirds[2].end)
            counts[2]++;
        });

        const total = counts.reduce((a, b) => a + b, 0) || 1;
        const percentages = counts.map((c) => Math.round((c / total) * 100));

        // Draw overlay rectangles and percentage labels
        const svg = d3
          .select("#teren")
          .append("svg")
          .attr("id", "zone-stats")
          .attr("width", width)
          .attr("height", height)
          .style("position", "absolute")
          .style("top", "0px")
          .style("left", "0px")
          .style("z-index", 2)
          .style("pointer-events", "none");

        // Colors for each zone
        const zoneColors = [
          "rgba(0,0,255,0.20)",
          "rgba(255,255,0,0.20)",
          "rgba(255,0,0,0.20)",
        ];

        thirds.forEach((zone, i) => {
          const zoneWidth = scalePosX(zone.end) - scalePosX(zone.start);
          const maxHeight = scalePosY(80) - scalePosY(0);
          const rectHeight = (percentages[i] / 100) * maxHeight;
          const rectY = scalePosY(80) - rectHeight;

          // Animated rectangle
          const rect = svg
            .append("rect")
            .attr("x", scalePosX(zone.start))
            .attr("y", scalePosY(80)) // start from bottom
            .attr("width", zoneWidth)
            .attr("height", 0)
            .attr("fill", zoneColors[i]);

          rect
            .transition()
            .duration(900)
            .attr("y", rectY)
            .attr("height", rectHeight);

          // Percentage label (animate up)
          svg
            .append("text")
            .attr("x", (scalePosX(zone.start) + scalePosX(zone.end)) / 2)
            .attr("y", rectY + rectHeight / 2)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "middle")
            .attr("font-size", "32px")
            .attr("font-weight", "bold")
            .attr("fill", "#222")
            .style("opacity", 0)
            .transition()
            .delay(900)
            .style("opacity", 1)
            .attr("y", rectY + rectHeight / 2)
            .text(`${percentages[i]}%`);

          // Zone name label (below the rect)
          svg
            .append("text")
            .attr("x", (scalePosX(zone.start) + scalePosX(zone.end)) / 2)
            .attr("y", scalePosY(80) + 20)
            .attr("text-anchor", "middle")
            .attr("font-size", "16px")
            .attr("fill", "#222")
            .text(zone.name);
        });
      }

      function drawMatchHeader() {
        var header = d3
          .select("[id=match-statistics]")
          .append("div")
          .attr("class", "match-header")
          .style("width", `${mainElement.offsetWidth}`)
          .style("padding", "20px")
          .style("border-radius", "10px")
          .style("display", "flex")
          .style("justify-content", "space-around")
          .style("align-items", "center")
          .style("flex-direction", "row")
          .html(
            `<div style="display:flex;flex-direction:column;align-items:center">
                    <img src="img/${matchInfo.homeTeam.id}/logo.png" width="100px" height="100px"/>
                    <h3>${matchInfo.homeTeam.name}</h3>
                </div>

                    <div><h2>${matchInfo.homeTeam.score} : ${matchInfo.awayTeam.score}</h2></div>

                <div style="display:flex;flex-direction:column;align-items:center">
                    <img src="img/${matchInfo.awayTeam.id}/logo.png" width="100px" height="100px"/>
                <h3>${matchInfo.awayTeam.name}</h3>
                </div>
            `
          );

        var optionsTabs = d3
          .select("[id=match-statistics]")
          .append("div")
          .attr("id", "options-tabs")
          .style("display", "flex")
          .style("margin-bottom", "10px");

        var mapStatisticsTabPlaceHolder = d3
          .select("[id=match-statistics]")
          .append("div")
          .attr("id", "map-statistics-tab-placeholder")
          .style("width", "100%")
          .style("height", "30px")
          .style("margin-bottom", "10px")
          .style("display", "none");

        var shotsTab = mapStatisticsTabPlaceHolder
          .append("div")
          .attr("id", "shots-tab")
          .attr("class", "selected")
          .style("width", "100px")
          .style("text-align", "center")
          .style("padding", "10px")
          .style("cursor", "pointer")
          .html("<strong>Shots</strong>")
          .on("click", function () {
            possesionTab.classed("selected", false);
            d3.select(this).classed("selected", true);

            selectedOption = "shots";

            handleMapStatistics(selectedTeamId, selectedOption);
          });

        var possesionTab = mapStatisticsTabPlaceHolder
          .append("div")
          .attr("id", "shots-tab")
          .attr("class", "")
          .style("width", "100px")
          .style("text-align", "center")
          .style("padding", "10px")
          .style("cursor", "pointer")
          .html("<strong>Possesion</strong>")
          .on("click", function () {
            shotsTab.classed("selected", false);
            d3.select(this).classed("selected", true);
            selectedOption = "possesion";

            handleMapStatistics(selectedTeamId, selectedOption);
          });

        var selectedTeamId = matchInfo.homeTeam.id;
        var selectedOption = "shots";

        var teamsDropdown = mapStatisticsTabPlaceHolder
          .append("select")
          .attr("id", "teams-dropdown")
          .style("width", "200px")
          .style("margin-left", "auto")
          .on("change", function () {
            selectedTeamId = d3.select(this).property("value");
            console.log("Selected team ID:", selectedTeamId);

            handleMapStatistics(selectedTeamId, selectedOption);
          });

        teamsDropdown
          .selectAll("option")
          .data([matchInfo.homeTeam, matchInfo.awayTeam])
          .enter()
          .append("option")
          .attr("value", function (d) {
            return d.id;
          })
          .text(function (d) {
            return d.name;
          });

        var lineupsTab = optionsTabs
          .append("div")
          .attr("id", "lineups-tab")
          .attr("class", "selected")
          .style("width", "100px")
          .style("text-align", "center")
          .style("padding", "10px")
          .style("cursor", "pointer")
          .html("<strong>Lineups</strong>")
          .on("click", function () {
            d3.selectAll("#options-tabs > div").classed("selected", false);
            d3.select(this).classed("selected", true);
            deleteMapStatistics();
            positionPlayers();
            // Add logic to show lineups here

            mapStatisticsTabPlaceHolder.style("display", "none");
          });

        var mapStatisticsTab = optionsTabs
          .append("div")
          .attr("id", "map-statistics-tab")
          .attr("class", "")
          .style("width", "100px")
          .style("text-align", "center")
          .style("padding", "10px")
          .style("cursor", "pointer")
          .html("<strong>Map Statistics</strong>")
          .on("click", function () {
            d3.selectAll("#options-tabs > div").classed("selected", false);
            d3.select(this).classed("selected", true);
            clearPlayers();

            handleMapStatistics(selectedTeamId, selectedOption);

            mapStatisticsTabPlaceHolder.style("display", "flex");
          });
      }

      function drawShots(locations) {
        d3.select("#heatmap").remove();
        d3.select("#zone-stats").remove();

        // Remove previous shot markers group
        d3.select("#shots-group").remove();

        // Sort locations by timestamp
        locations = locations.slice().sort((a, b) => a.timestamp - b.timestamp);

        // Select the SVG for the pitch
        var svg = d3.select("#teren");

        // Create a group for shot markers
        var shotsGroup = svg.append("g").attr("id", "shots-group");

        // Tooltip div for shots
        var tooltip = d3
          .select("body")
          .append("div")
          .attr("class", "shot-tooltip")
          .style("position", "absolute")
          .style("background", "rgba(255,255,255,0.97)")
          .style("border", "1px solid #333")
          .style("padding", "8px 12px")
          .style("border-radius", "6px")
          .style("pointer-events", "none")
          .style("font", "14px sans-serif")
          .style("display", "none")
          .style("z-index", 1000);

        // Draw each shot as a circle inside the group, animate one by one
        locations.forEach((location, i) => {
          var circle = shotsGroup
            .append("circle")
            .attr("class", "shot-marker")
            .attr("cx", scalePosX(location.x))
            .attr("cy", scalePosY(location.y))
            .attr("r", 0)
            .attr("fill", location.isGoal ? "blue" : "none")
            .attr("stroke", location.isGoal ? "blue" : "black")
            .attr("stroke-width", 3)
            .attr("opacity", 0.85);

          circle
            .transition()
            .delay(i * 250)
            .duration(350)
            .attr("r", 12);

          circle
            .on("mouseover", function () {
              d3.select(this).attr("fill", "#e0e0ff");
              tooltip
                .html(
                  `<strong>${location.player}</strong><br>
                Time: ${location.timestamp}'<br>
                xG: ${location.xG}`
                )
                .style("left", d3.event.pageX + 15 + "px")
                .style("top", d3.event.pageY - 28 + "px")
                .style("display", "block");
            })
            .on("mousemove", function () {
              tooltip
                .style("left", d3.event.pageX + 15 + "px")
                .style("top", d3.event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select(this).attr("fill", location.isGoal ? "blue" : "none");
              tooltip.style("display", "none");
            });
        });
      }

      function deleteMapStatistics() {
        d3.select("#heatmap").remove();
        d3.select("#zone-stats").remove();
        d3.select("#shots-group").remove();
      }

      function getIsFirstHalfLeft(teamId) {
        var firstPass = events.find(
          (event) => event.type.id == 30 && event.play_pattern.id == 9
        );

        if (
          firstPass.pass.end_location[0] < 60 &&
          firstPass.team.id == teamId
        ) {
          return true;
        } else {
          return false;
        }
      }

      function handleMapStatistics(teamId, optionType) {
        deleteMapStatistics();
        var isFirstHalfLeft = getIsFirstHalfLeft(teamId);

        if (optionType === "shots") {
          const locations = events
            .filter(
              (event) =>
                event.type.id == 16 &&
                event.team.id == teamId &&
                event.location != undefined
            )
            .map((event) => {
              if (event.period == 1) {
                if (isFirstHalfLeft) {
                  return {
                    x: 120 - event.location[0],
                    y: 80 - event.location[1],
                    isGoal: event.shot.outcome.id === 97,
                    timestamp: event.minute,
                    player: event.player.name,
                    xG: event?.shot?.statsbomb_xg ?? 0,
                  };
                } else {
                  return {
                    x: event.location[0],
                    y: event.location[1],
                    isGoal: event.shot.outcome.id === 97,
                    timestamp: event.minute,
                    player: event.player.name,
                    xG: event?.shot?.statsbomb_xg ?? 0,
                  };
                }
              } else {
                if (isFirstHalfLeft) {
                  return {
                    x: event.location[0],
                    y: event.location[1],
                    isGoal: event.shot.outcome.id === 97,
                    timestamp: event.minute,
                    player: event.player.name,
                    xG: event?.shot?.statsbomb_xg ?? 0,
                  };
                } else {
                  return {
                    x: 120 - event.location[0],
                    y: 80 - event.location[1],
                    isGoal: event.shot.outcome.id === 97,
                    timestamp: event.minute,
                    player: event.player.name,
                    xG: event?.shot?.statsbomb_xg ?? 0,
                  };
                }
              }
            });

          console.log("Shot locations:", locations);

          drawShots(locations);
        } else if (optionType === "possesion") {
          const locations = getPosessionLocations(teamId);

          drawPossessionStats(locations);
        }
      }

      function getPosessionLocations(teamId) {
        var isFirstHalfLeft = getIsFirstHalfLeft(teamId);

        var possessionEvents = events.filter(
          (event) =>
            event.possession_team.id == teamId && event.location != undefined
        );
        console.log("Possession events:", possessionEvents);
        var locations = possessionEvents.map((event) => {
          return {
            x: event.location[0],
            y: event.location[1],
          };
        });
        return locations;
      }

      function drawMapStatisticsTab() {
        var tabs = d3
          .select("[id=match-statistics]")
          .append("div")
          .attr("id", "options-tabs");
      }

      function drawStatistics() {
        // Remove previous statistics if any
        d3.select("#statistics-wrapper").remove();

        var divWrapper = d3
          .select("[id=match-statistics]")
          .append("div")
          .attr("id", "statistics-wrapper")
          .style("width", `${mainElement.offsetWidth}`)
          .style("padding", "20px")
          .style("background-color", "beige")
          .style("border-radius", "10px")
          .style("display", "flex")
          .style("flex-direction", "column")
          .style("gap", "20px");

        var outerDivs = divWrapper
          .selectAll("div.stat-row")
          .data(statistics)
          .enter()
          .append("div")
          .attr("class", "stat-row")
          .style("width", "100%");

        var innerLabelDivs = outerDivs
          .append("div")
          .style("width", "100%")
          .style("display", "flex")
          .style("justify-content", "space-between")
          .style("align-items", "center")
          .html(function (d) {
            return `
            <div><strong>${d.homeTeamValue}</strong></div>
            <div><strong>${d.label}</strong></div>
            <div><strong>${d.awayTeamValue}</strong></div>`;
          });

        var progressBarWrapper = outerDivs
          .append("div")
          .attr("class", "progress-bar-wrapper")
          .style("width", "100%")
          .style("height", "20px")
          .style("display", "flex")
          .style("gap", "5px");

        // Home progress bar
        progressBarWrapper
          .append("div")
          .attr("class", "home-progress-bar-bg")
          .style("flex", "1")
          .style("display", "flex")
          .style("justify-content", "flex-end")
          .style("background-color", "lightgray")
          .append("div")
          .attr("class", "home-progress-bar")
          .style("width", "0%")
          .style("height", "100%")
          .style("background-color", function (d) {
            return d.homeTeamProgressBarWidth > d.awayTeamProgressBarWidth
              ? "red"
              : "black";
          })
          .transition()
          .duration(800)
          .style("width", function (d) {
            return `${d.homeTeamProgressBarWidth}`;
          });

        // Away progress bar
        progressBarWrapper
          .append("div")
          .attr("class", "away-progress-bar-bg")
          .style("flex", "1")
          .style("display", "flex")
          .style("justify-content", "flex-start")
          .style("background-color", "lightgray")
          .append("div")
          .attr("class", "away-progress-bar")
          .style("width", "0%")
          .style("height", "100%")
          .style("background-color", function (d) {
            return d.awayTeamProgressBarWidth > d.homeTeamProgressBarWidth
              ? "red"
              : "black";
          })
          .transition()
          .duration(800)
          .style("width", function (d) {
            return `${d.awayTeamProgressBarWidth}`;
          });
      }

      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      function animateBarToWidth(bar, targetWidth, color) {
        let parent = bar.node().parentNode;
        let parentWidth = parent.getBoundingClientRect().width;
        let barWidth = bar.node().getBoundingClientRect().width;
        let currentWidth = (barWidth / parentWidth) * 100;

        let target = parseFloat(targetWidth);

        if (isNaN(target)) {
          bar.style("width", targetWidth).style("background-color", color);
          return;
        }
        bar
          .transition()
          .duration(800)
          .styleTween("width", function () {
            return d3.interpolate(currentWidth + "%", target + "%");
          })
          .style("background-color", color);
      }

      const debouncedUpdateDrawStatistics = debounce(
        function updateDrawStatistics() {
          var statRows = d3
            .selectAll("[id=statistics-wrapper] .stat-row")
            .data(statistics);

          statRows.select("div").html(function (d) {
            return `
        <div><strong>${d.homeTeamValue}</strong></div>
        <div><strong>${d.label}</strong></div>
        <div><strong>${d.awayTeamValue}</strong></div>`;
          });

          statRows.each(function (d) {
            var homeBar = d3.select(this).select(".home-progress-bar");
            var color =
              parseFloat(d.homeTeamProgressBarWidth) >
              parseFloat(d.awayTeamProgressBarWidth)
                ? "red"
                : "black";
            animateBarToWidth(homeBar, d.homeTeamProgressBarWidth, color);

            var awayBar = d3.select(this).select(".away-progress-bar");
            var color2 =
              parseFloat(d.awayTeamProgressBarWidth) >
              parseFloat(d.homeTeamProgressBarWidth)
                ? "red"
                : "black";
            animateBarToWidth(awayBar, d.awayTeamProgressBarWidth, color2);
          });
        },
        200
      );

      function updateDrawStatistics() {
        debouncedUpdateDrawStatistics();
      }

      function clearMain() {
        document.querySelector("#match-statistics").innerHTML = "";
      }

      async function getMatchData() {
        const lineupsResponse = await fetch(`data/lineups/${matchId}.json`);
        lineups = await lineupsResponse.json();

        const positionsResponse = await fetch("data/positions.json");
        positions = await positionsResponse.json();
        clearMain();

        await getMatchInfo();
        await loadMatchEvents();

        drawMatchHeader();
        drawTeren();
        positionPlayers();

        getImportantEvents();
        drawTimeline();

        var maxMinute = d3.max(events, function (d) {
          return d.minute;
        });

        getMatchStatistics(maxMinute);
        drawStatistics();

        // const locations = getEventLocations();
        // renderHeatmap(locations);
      }

      function drawTimeline() {
        var maxMinute = d3.max(events, (d) => d.minute);
        var teren = document.querySelector("#teren");

        var timelineWrapper = d3
          .select("[id=match-statistics]")
          .append("div")
          .attr("id", "timeline-wrapper")
          .style("position", "relative")
          .style("width", `${teren.width.baseVal.value}px`)
          .style("background-color", "beige")
          .style("border-radius", "10px")
          .style("margin", "20px 0")
          .style("padding", "20px 0")
          .style("height", "80px");

        var width = teren.width.baseVal.value;
        var height = 120;
        var padding = 20;

        var svg = timelineWrapper
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .style("position", "absolute")
          .style("top", "0")
          .style("left", "0");

        var x = d3.scale
          .linear()
          .domain([0, maxMinute])
          .range([padding, width - padding]);

        // Create a wrapper for the slider and label
        var sliderWrapper = timelineWrapper
          .append("div")
          .style("position", "absolute")
          .style("top", `${height / 2 - 12}px`)
          .style("left", `${padding}px`)
          .style("width", `${width - 2 * padding}px`)
          .style("height", "24px")
          .style("z-index", "2");

        // Add the range input (slider)
        var slider = sliderWrapper
          .append("input")
          .attr("type", "range")
          .attr("min", 0)
          .attr("max", maxMinute)
          .attr("value", maxMinute)
          .attr("step", 1)
          .style("width", "100%")
          .style("height", "4px")
          .style("appearance", "none")
          .style("background", "#999")
          .style("border-radius", "2px")
          .style("position", "absolute")
          .style("top", "10px")
          .style("left", "0px")
          .on("input", function () {
            var val = +this.value;
            updateSliderLabel(val);
            getMatchStatistics(val);
            updateDrawStatistics();
          });

        // Add the label for the current minute (above the thumb)
        var sliderLabel = sliderWrapper
          .append("div")
          .attr("id", "slider-minute-label")
          .style("position", "absolute")
          .style("top", "-18px")
          .style("left", "0px")
          .style("transform", "translateX(-50%)")
          .style("background", "#fff")
          .style("padding", "2px 8px")
          .style("border-radius", "8px")
          .style("font-size", "13px")
          .style("font-weight", "bold")
          .style("box-shadow", "0 1px 4px rgba(0,0,0,0.08)")
          .text(maxMinute + "'");

        // Function to update label position and value
        function updateSliderLabel(val) {
          var min = +slider.attr("min");
          var max = +slider.attr("max");
          var percent = (val - min) / (max - min);
          var sliderWidth = slider.node().offsetWidth;
          var labelWidth = sliderLabel.node().offsetWidth;
          var left = percent * (sliderWidth - 16) + 8; // 8px padding for thumb
          sliderLabel.style("left", `${left}px`).text(val + "'");
        }

        // Initialize label position
        setTimeout(function () {
          updateSliderLabel(maxMinute);
        }, 0);

        // Add tooltip div
        const tooltip = d3
          .select("body")
          .append("div")
          .attr("class", "timeline-tooltip")
          .style("position", "absolute")
          .style("background", "rgba(255,255,255,0.95)")
          .style("border", "1px solid #333")
          .style("padding", "8px 12px")
          .style("border-radius", "6px")
          .style("pointer-events", "none")
          .style("font", "14px sans-serif")
          .style("display", "none")
          .style("z-index", 1000);

        function showTooltip(d, event) {
          tooltip
            .html(
              `
                <strong>${d.minute}' - ${d.player.name}</strong><br>
                Team: ${d.team.name}<br>
                Shot Type: ${d.shot?.type?.name || "N/A"}<br>
                Technique: ${d.shot?.technique?.name || "N/A"}<br>
                Body Part: ${d.shot?.body_part?.name || "N/A"}<br>
                Play Pattern: ${d.play_pattern?.name || "N/A"}<br>
                xG: ${d.shot?.statsbomb_xg?.toFixed(2) || "0.00"}<br>
              `
            )
            .style("left", event.pageX + 15 + "px")
            .style("top", event.pageY - 28 + "px")
            .style("display", "block");
        }

        function hideTooltip() {
          tooltip.style("display", "none");
        }

        var teamIds = [...new Set(timelineEvents.map((e) => e.team.id))];
        var teamA = teamIds[0];
        var teamB = teamIds[1];

        svg
          .selectAll(".goal")
          .data(timelineEvents)
          .enter()
          .append("circle")
          .attr("class", "goal")
          .attr("cx", (d) => x(d.minute))
          .attr("cy", (d) =>
            d.team.id === teamA ? height / 2 - 20 : height / 2 + 20
          )
          .attr("r", 10)
          .attr("fill", (d) => (d.team.id === teamA ? "#1f77b4" : "#d62728"))
          .attr("stroke", "#fff")
          .attr("stroke-width", 2)
          .on("mouseover", function (d) {
            showTooltip(d, d3.event);
          })
          .on("mousemove", function (d) {
            tooltip
              .style("left", d3.event.pageX + 15 + "px")
              .style("top", d3.event.pageY - 28 + "px");
          })
          .on("mouseout", hideTooltip);

        svg
          .selectAll(".minute-label")
          .data(timelineEvents)
          .enter()
          .append("text")
          .attr("x", (d) => x(d.minute))
          .attr("y", (d) =>
            d.team.id === teamA ? height / 2 - 35 : height / 2 + 45
          )
          .attr("text-anchor", "middle")
          .attr("font-size", "11px")
          .text((d) => d.minute + "'");

        var playButtonWrapper = timelineWrapper
          .append("div")
          .style("position", "absolute")
          .style("left", "10px")
          .style("bottom", "10px");

        // Track play/pause state using a variable outside the click handler
        var playing = false;
        var interval = null;
        var playButton = playButtonWrapper
          .append("button")
          .attr("id", "play-button")
          .html('<i class="fa fa-play" aria-hidden="true"></i>')
          .style("padding", "0 10px")
          .style("font-size", "10px")
          .style("cursor", "pointer")
          .on("click", function () {
            var slider = d3.select("input[type=range]");
            var currentValue = +slider.property("value");
            var maxValue = +slider.attr("max");
            if (!playing) {
              d3.select(this).html(
                '<i class="fa fa-pause" aria-hidden="true"></i>'
              );
              playing = true;
              interval = setInterval(() => {
                if (currentValue < maxValue) {
                  currentValue += 5;
                  if (currentValue > maxValue) {
                    currentValue = maxValue;
                  }
                  updateSliderLabel(currentValue);
                  slider.property("value", currentValue);
                  getMatchStatistics(currentValue);
                  updateDrawStatistics();
                } else {
                  updateSliderLabel(maxValue);
                  clearInterval(interval);
                  playing = false;
                  d3.select(playButton.node()).html(
                    '<i class="fa fa-play" aria-hidden="true"></i>'
                  );
                }
              }, 1000);
            } else {
              d3.select(this).html(
                '<i class="fa fa-play" aria-hidden="true"></i>'
              );
              playing = false;
              clearInterval(interval);
            }
          });
      }

      async function getMatchInfo() {
        const matches = await fetch("data/matches/9/281.json");
        const matchesJson = await matches.json();
        var match = matchesJson.find((match) => match.match_id == matchId);
        matchInfo = {
          homeTeam: {
            id: match.home_team.home_team_id,
            name: match.home_team.home_team_name,
            score: match.home_score,
          },
          awayTeam: {
            id: match.away_team.away_team_id,
            name: match.away_team.away_team_name,
            score: match.away_score,
          },
        };
      }

      async function loadMatches() {
        const matchesResponse = await fetch("data/matches/9/281.json");
        matches = await matchesResponse.json(); // Parse the JSON

        console.log(matches);
        var orderedMatches = matches.sort((a, b) => {
          return a.match_week - b.match_week;
        });
        var aside = document.querySelector("aside");

        orderedMatches.forEach((match) => {
          //main div
          var matchDiv = document.createElement("div");
          matchDiv.className = "match-card main";

          //info div(left side of the card)
          var infoDiv = document.createElement("div");
          infoDiv.className = "info";
          infoDiv.style.display = "flex";
          infoDiv.style.gap = "10px";

          //bundesliga logo
          var bundesligaLogo = document.createElement("img");
          bundesligaLogo.src = "img/Bundesliga_logo.png";
          bundesligaLogo.style.width = "50px";
          bundesligaLogo.style.height = "50px";
          infoDiv.appendChild(bundesligaLogo);

          //matchday info for onfo div
          var matchdayInfo = document.createElement("div");
          var matchdayInfoMatchWeek = document.createElement("div");
          matchdayInfoMatchWeek.innerHTML = `Matchday: ${match.match_week}`;
          matchdayInfo.appendChild(matchdayInfoMatchWeek);
          var matchdayInfoKickoff = document.createElement("div");
          // Format kick_off to show only hour and minute (HH:MM)
          const kickoffTime = match.kick_off ? match.kick_off.slice(0, 5) : "";
          matchdayInfoKickoff.innerHTML = `</strong> ${match.match_date}, ${kickoffTime}</strong>`;
          matchdayInfo.appendChild(matchdayInfoKickoff);
          infoDiv.appendChild(matchdayInfo);
          matchDiv.appendChild(infoDiv);

          //result div for info div
          var resultDiv = document.createElement("div");
          resultDiv.style.display = "flex";
          resultDiv.style.gap = "20px";
          resultDiv.style.alignItems = "center";

          //home team logo
          var homeTeamLogo = document.createElement("img");
          homeTeamLogo.src = `img/${match.home_team.home_team_id}/logo.png`;
          homeTeamLogo.style.width = "50px";
          homeTeamLogo.style.height = "50px";

          //away team logo
          var awayTeamLogo = document.createElement("img");
          awayTeamLogo.src = `img/${match.away_team.away_team_id}/logo.png`;
          awayTeamLogo.style.width = "50px";
          awayTeamLogo.style.height = "50px";

          //result div for result div
          var result = document.createElement("div");
          result.innerHTML = `<div style="display:flex;gap:5px"><div><h4>${match.home_score}</h4></div>
                    <div><h4>:</h4></div>

                    <div><h4>${match.away_score}</h4></div></div>`;

          resultDiv.appendChild(homeTeamLogo);
          resultDiv.appendChild(result);
          resultDiv.appendChild(awayTeamLogo);

          matchDiv.appendChild(resultDiv);

          matchDiv.style.cursor = "pointer";
          matchDiv.onclick = function () {
            matchId = match.match_id;
            console.log("Clicked match ID:", matchId);
            getMatchData();
          };
          aside.appendChild(matchDiv);
        });
      }

      async function loadMatchEvents() {
        var eventsResponse = await fetch(`data/events/${matchId}.json`);

        events = await eventsResponse.json(); // Parse the JSON
      }

      var timelineEvents = [];

      function getImportantEvents() {
        console.log("Important events");

        timelineEvents = events.filter(
          (event) => event.type.id === 16 && event.shot.outcome.id === 97
        );

        console.log("Timeline events:", timelineEvents);
      }

      function getMatchStatistics(minute) {
        var homeTeam = events.find(
          (event) => event.team.id == matchInfo.homeTeam.id
        ).team.name;
        var awayTeam = events.find(
          (event) => event.team.id == matchInfo.awayTeam.id
        ).team.name;

        let eventsToMin = events.filter((event) => event.minute <= minute);

        var homeTeamPossessions = 0;
        var awayTeamPossessions = 0;

        var homeTeamShots = 0;
        var awayTeamShots = 0;
        var homeTeamShotsOnTarget = 0;
        var awayTeamShotsOnTarget = 0;
        var homeTeamXg = 0;
        var awayTeamXg = 0;

        var homeTeamCorners = 0;
        var awayTeamCorners = 0;

        var homeTeamPasses = 0;
        var awayTeamPasses = 0;
        var homeTeamPassesIncompleted = 0;
        var awayTeamPassesIncompleted = 0;
        var homeTeamPassesCompleted = 0;
        var awayTeamPassesCompleted = 0;
        var homeTeamPassesPercentage = 0;
        var awayTeamPassesPercentage = 0;

        var homeTeamOffsides = 0;
        var awayTeamOffsides = 0;

        var homeTeamFouls = 0;
        var awayTeamFouls = 0;

        eventsToMin.forEach((event) => {
          // Possession events
          if (event.possession_team.id == matchInfo.homeTeam.id) {
            homeTeamPossessions++;
          } else {
            awayTeamPossessions++;
          }

          //Shots events
          if (event.type.id == 16) {
            if (event.team.id == matchInfo.homeTeam.id) {
              homeTeamXg += event.shot.statsbomb_xg;
              homeTeamShots++;
              if (
                event.shot.outcome.id == 97 ||
                event.shot.outcome.id == 100 ||
                event.shot.outcome.id == 116
              ) {
                homeTeamShotsOnTarget++;
              }
            } else {
              awayTeamXg += event.shot.statsbomb_xg;
              awayTeamShots++;
              if (
                event.shot.outcome.id == 97 ||
                event.shot.outcome.id == 100 ||
                event.shot.outcome.id == 116
              ) {
                awayTeamShotsOnTarget++;
              }
            }
          }

          //pass events
          if (event.type.id == 30) {
            if (event.team.id == matchInfo.homeTeam.id) {
              if (event.pass?.type?.id == 61) {
                homeTeamCorners++;
              }

              if (!event.pass?.outcome) {
                homeTeamPasses++;
              } else if (event.pass.outcome.id == 9) {
                homeTeamPassesIncompleted++;
              } else if (event.pass.outcome.id == 76) {
                homeTeamOffsides++;
              }
            } else {
              if (event.pass?.type?.id == 61) {
                awayTeamCorners++;
              }

              if (!event.pass?.outcome) {
                awayTeamPasses++;
              } else if (event.pass.outcome.id == 9) {
                awayTeamPassesIncompleted++;
              } else if (event.pass.outcome.id == 76) {
                awayTeamOffsides++;
              }
            }
          }

          //offsides events
          if (event.type.id == 8) {
            if (event.team.id == matchInfo.homeTeam.id) {
              homeTeamOffsides++;
            } else {
              awayTeamOffsides++;
            }
          }

          //fouls events
          if (event.type.id == 22) {
            if (event.team.id == matchInfo.homeTeam.id) {
              homeTeamFouls++;
            } else {
              awayTeamFouls++;
            }
          }
        });

        var homeTeamPossessionPercentage = customRound(
          (homeTeamPossessions / eventsToMin.length) * 100
        );
        var awayTeamPossessionPercentage = customRound(
          (awayTeamPossessions / eventsToMin.length) * 100
        );
        statistics = [
          {
            label: "Possession",
            homeTeamValue: homeTeamPossessionPercentage,
            homeTeamProgressBarWidth: `${homeTeamPossessionPercentage}%`,
            awayTeamValue: awayTeamPossessionPercentage,
            awayTeamProgressBarWidth: `${awayTeamPossessionPercentage}%`,
          },
          {
            label: "Shots",
            homeTeamValue: homeTeamShots,
            homeTeamProgressBarWidth: `${
              (homeTeamShots / (homeTeamShots + awayTeamShots)) * 100
            }%`,
            awayTeamValue: awayTeamShots,
            awayTeamProgressBarWidth: `${
              (awayTeamShots / (homeTeamShots + awayTeamShots)) * 100
            }%`,
          },
          {
            label: "Shots on target",
            homeTeamValue: homeTeamShotsOnTarget,
            homeTeamProgressBarWidth: `${
              (homeTeamShotsOnTarget /
                (homeTeamShotsOnTarget + awayTeamShotsOnTarget)) *
              100
            }%`,
            awayTeamValue: awayTeamShotsOnTarget,
            awayTeamProgressBarWidth: `${
              (awayTeamShotsOnTarget /
                (homeTeamShotsOnTarget + awayTeamShotsOnTarget)) *
              100
            }%`,
          },
          {
            label: "Expected goals xG",
            homeTeamValue: homeTeamXg.toFixed(2),
            homeTeamProgressBarWidth: `${
              (homeTeamXg / (homeTeamXg + awayTeamXg)) * 100
            }%`,
            awayTeamValue: awayTeamXg.toFixed(2),
            awayTeamProgressBarWidth: `${
              (awayTeamXg / (homeTeamXg + awayTeamXg)) * 100
            }%`,
          },
          {
            label: "Corners",
            homeTeamValue: homeTeamCorners,
            homeTeamProgressBarWidth: `${
              (homeTeamCorners / (homeTeamCorners + awayTeamCorners)) * 100
            }%`,
            awayTeamValue: awayTeamCorners,
            awayTeamProgressBarWidth: `${
              (awayTeamCorners / (homeTeamCorners + awayTeamCorners)) * 100
            }%`,
          },
          {
            label: "Passes",
            homeTeamValue: `(${
              homeTeamPasses - homeTeamPassesIncompleted
            }/${homeTeamPasses}) ${(
              ((homeTeamPasses - homeTeamPassesIncompleted) / homeTeamPasses) *
              100
            ).toFixed(2)}%`,
            homeTeamProgressBarWidth: `${
              ((homeTeamPasses - homeTeamPassesIncompleted) / homeTeamPasses) *
              100
            }%`,
            awayTeamValue: `(${
              awayTeamPasses - awayTeamPassesIncompleted
            }/${awayTeamPasses}) ${(
              ((awayTeamPasses - awayTeamPassesIncompleted) / awayTeamPasses) *
              100
            ).toFixed(2)}%`,
            awayTeamProgressBarWidth: `${
              ((awayTeamPasses - awayTeamPassesIncompleted) / awayTeamPasses) *
              100
            }%`,
          },
          {
            label: "Offsides",
            homeTeamValue: homeTeamOffsides,
            homeTeamProgressBarWidth: `${
              (homeTeamOffsides / (homeTeamOffsides + awayTeamOffsides)) * 100
            }%`,
            awayTeamValue: awayTeamOffsides,
            awayTeamProgressBarWidth: `${
              (awayTeamOffsides / (homeTeamOffsides + awayTeamOffsides)) * 100
            }%`,
          },
          {
            label: "Fouls",
            homeTeamValue: homeTeamFouls,
            homeTeamProgressBarWidth: `${
              (homeTeamFouls / (homeTeamFouls + awayTeamFouls)) * 100
            }%`,
            awayTeamValue: awayTeamFouls,
            awayTeamProgressBarWidth: `${
              (awayTeamFouls / (homeTeamFouls + awayTeamFouls)) * 100
            }%`,
          },
        ];
        console.log("Statistics:", statistics);
      }

      function customRound(num) {
        var intPart = Math.floor(num);
        var decimal = (num - intPart) * 10;
        if (decimal >= 5) {
          return Math.ceil(num);
        } else {
          return Math.floor(num);
        }
      }

      function getEventLocations() {
        return events
          .filter(
            (e) => e.location && e.location.length === 2 && e.type.id == 16
          )
          .map((e) => {
            console.log(e);
            if (e.period == 2) {
              return {
                x: 120 - e.location[0],
                y: 80 - e.location[1],
              };
            } else {
              return {
                x: e.location[0],
                y: e.location[1],
              };
            }
          });
      }

      loadMatches();
    </script>
  </body>
</html>
